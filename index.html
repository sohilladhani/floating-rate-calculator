<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Loan Calculator - Floating Interest Rate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <style>
        @import url('https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css');
        
        /* Dark mode variables */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --shadow-color: rgba(0,0,0,0.3);
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        [data-theme="dark"] .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #581c87 100%);
        }
        
        .card-shadow {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .card-shadow:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px var(--shadow-color);
        }
        
        [data-theme="dark"] .card-shadow:hover {
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }
        
        .progress-bar {
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .input-field {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        
        [data-theme="dark"] .input-field:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .option-card {
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        .option-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px var(--shadow-color);
        }
        
        .option-card.selected {
            border: 2px solid #3B82F6;
            background: linear-gradient(135deg, #EBF4FF 0%, #DBEAFE 100%);
        }
        
        [data-theme="dark"] .option-card.selected {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-color: #60a5fa;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .chart-container {
            position: relative;
            height: 200px;
        }
        
        .donut-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(#EF4444 0deg var(--interest-angle), #10B981 var(--interest-angle) 360deg);
            position: relative;
            margin: 0 auto;
        }
        
        .donut-chart::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            background: var(--bg-secondary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .print-hidden {
            display: none;
        }
        
        /* Dark mode toggle switch */
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            transition: 0.4s;
            border-radius: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .slider:before {
            position: absolute;
            content: "‚òÄÔ∏è";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #1e40af, #3730a3);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
            content: "üåô";
        }
        
        /* Dark mode specific styles */
        [data-theme="dark"] .text-gray-800 {
            color: #f1f5f9 !important;
        }
        
        [data-theme="dark"] .text-gray-600 {
            color: #cbd5e1 !important;
        }
        
        [data-theme="dark"] .text-gray-500 {
            color: #94a3b8 !important;
        }
        
        [data-theme="dark"] .text-gray-700 {
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .bg-gray-50 {
            background-color: var(--bg-tertiary) !important;
        }
        
        [data-theme="dark"] .bg-gray-100 {
            background-color: var(--bg-tertiary) !important;
        }
        
        [data-theme="dark"] .bg-gray-200 {
            background-color: #475569 !important;
        }
        
        [data-theme="dark"] .border-gray-200,
        [data-theme="dark"] .border-gray-300 {
            border-color: var(--border-color) !important;
        }
        
        /* Glowing effects for dark mode */
        [data-theme="dark"] .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.05);
        }
        
        [data-theme="dark"] .progress-bar {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }
        
        /* Enhanced button styles for dark mode */
        [data-theme="dark"] button {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] button:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        
        /* Color scheme updates for dark mode */
        [data-theme="dark"] .bg-blue-50 {
            background-color: rgba(30, 58, 138, 0.2) !important;
        }
        
        [data-theme="dark"] .bg-green-50 {
            background-color: rgba(5, 46, 22, 0.3) !important;
        }
        
        [data-theme="dark"] .bg-purple-50 {
            background-color: rgba(88, 28, 135, 0.2) !important;
        }
        
        [data-theme="dark"] .bg-yellow-50 {
            background-color: rgba(146, 64, 14, 0.2) !important;
        }
        
        [data-theme="dark"] .bg-red-50 {
            background-color: rgba(127, 29, 29, 0.2) !important;
        }
        
        [data-theme="dark"] .bg-orange-50 {
            background-color: rgba(154, 52, 18, 0.2) !important;
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-hidden { display: block !important; }
            .card-shadow { box-shadow: none !important; border: 1px solid #e5e7eb; }
            .gradient-bg { background: #f3f4f6 !important; color: #1f2937 !important; }
            [data-theme="dark"] * { background: white !important; color: black !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg text-white py-8 mb-8">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <div class="flex justify-between items-center mb-4">
                    <div></div>
                    <div>
                        <h1 class="text-4xl font-bold mb-2">Home Loan Calculator</h1>
                        <p class="text-blue-100 text-lg">Floating Interest Rate Calculator - RBI Compliant</p>
                    </div>
                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center space-x-3 no-print">
                        <span class="text-sm text-blue-100">üåû</span>
                        <label class="theme-toggle">
                            <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                            <span class="slider"></span>
                        </label>
                        <span class="text-sm text-blue-100">üåô</span>
                    </div>
                </div>
                <div class="mt-4 text-sm">
                    <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">Real-time Calculations</span>
                    <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full ml-2">Three Strategic Options</span>
                    <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full ml-2">Professional Grade</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 pb-8">
        <!-- Loan Progress Panel -->
        <div class="mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex items-center">
                    <span class="w-3 h-3 bg-blue-500 rounded-full mr-3"></span>
                    Loan Overview & Progress
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600" id="originalAmountDisplay">‚Çπ20,00,000</div>
                        <div class="text-sm text-gray-600">Original Amount</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600" id="amountPaidDisplay">‚Çπ4,50,619</div>
                        <div class="text-sm text-gray-600">Amount Paid</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-orange-600" id="outstandingDisplay">‚Çπ18,29,112</div>
                        <div class="text-sm text-gray-600">Outstanding</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-600" id="progressDisplay">14.2%</div>
                        <div class="text-sm text-gray-600">Progress</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Loan Completion Progress</span>
                        <span id="progressText">14.2% Complete</span>
                    </div>
                    <div class="bg-gray-200 rounded-full h-4">
                        <div class="bg-gradient-to-r from-blue-500 to-green-500 h-4 rounded-full progress-bar" 
                             id="mainProgressBar" style="width: 14.2%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>Start</span>
                        <span id="emisPaidText">17 EMIs Paid</span>
                        <span>Complete</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Panel -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Loan Parameters</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Original Loan Amount (‚Çπ)</label>
                            <input type="number" id="originalAmount" value="2000000" 
                                   class="w-full p-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500"
                                   onchange="calculateAll()">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Current Interest Rate (%)</label>
                            <input type="number" id="currentRate" value="10.75" step="0.01" 
                                   class="w-full p-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500"
                                   onchange="calculateAll()">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">New Interest Rate (%)</label>
                            <input type="number" id="newRate" value="8.75" step="0.01" 
                                   class="w-full p-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-green-500"
                                   onchange="calculateAll()">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Original Tenure (months)</label>
                            <input type="number" id="originalTenure" value="120" 
                                   class="w-full p-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500"
                                   onchange="calculateAll()">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Calculated EMI (‚Çπ)</label>
                            <div class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 text-gray-700 font-semibold" 
                                 id="calculatedEMIDisplay">‚Çπ26,507</div>
                            <p class="text-xs text-gray-500 mt-1">Auto-calculated based on original loan terms</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">EMIs Paid So Far</label>
                            <input type="number" id="emisPaid" value="17" 
                                   class="w-full p-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500"
                                   onchange="calculateAll()">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Income & DTI Analysis</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gross Annual Income (‚Çπ)</label>
                            <input type="number" id="grossIncome" value="1200000" 
                                   class="w-full p-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500"
                                   onchange="calculateAll()">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Other EMIs (‚Çπ)</label>
                            <input type="number" id="otherEMIs" value="5000" 
                                   class="w-full p-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500"
                                   onchange="calculateAll()">
                        </div>
                        
                        <div class="pt-4 border-t">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Monthly Income</span>
                                <span class="font-semibold" id="monthlyIncomeDisplay">‚Çπ1,00,000</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Total Monthly EMIs</span>
                                <span class="font-semibold" id="totalEMIsDisplay">‚Çπ31,507</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Current DTI Ratio</span>
                                <span class="font-semibold text-blue-600" id="currentDTIDisplay">31.5%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Quick Actions</h3>
                    
                    <div class="space-y-3">
                        <button onclick="resetToDefaults()" 
                                class="w-full bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                            Reset to Default Values
                        </button>
                        <button onclick="testScenario('higher')" 
                                class="w-full bg-red-500 text-white py-3 px-4 rounded-lg hover:bg-red-600 transition-colors font-medium">
                            Test Higher Rate (+1%)
                        </button>
                        <button onclick="testScenario('lower')" 
                                class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors font-medium">
                            Test Lower Rate (-0.5%)
                        </button>
                        <button onclick="window.print()" 
                                class="w-full bg-purple-500 text-white py-3 px-4 rounded-lg hover:bg-purple-600 transition-colors font-medium no-print">
                            Print Report
                        </button>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">RBI Guidelines</h4>
                        <p class="text-sm text-blue-700">As per RBI guidelines, you have the right to choose how to adjust your loan when rates change.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Three Strategic Options Dashboard -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-3"></span>
                Three Strategic Options (RBI Compliant)
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Option 1: Keep Tenure -->
                <div class="option-card bg-white rounded-xl p-6 card-shadow" id="option1" onclick="selectOption(1)">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl">üìÖ</span>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">Keep Tenure Unchanged</h3>
                        <p class="text-sm text-gray-600">Adjust EMI only</p>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">New EMI</span>
                            <span class="font-bold text-blue-600" id="option1EMI">‚Çπ24,186</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tenure</span>
                            <span class="font-semibold" id="option1Tenure">103 months</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Interest</span>
                            <span class="font-semibold" id="option1Interest">‚Çπ7,63,158</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">DTI Ratio</span>
                            <span class="font-semibold" id="option1DTI">29.4%</span>
                        </div>
                        <div class="text-center mt-4">
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm" id="option1Savings">Save ‚Çπ2,321/month</span>
                        </div>
                    </div>
                </div>
                
                <!-- Option 2: Keep EMI -->
                <div class="option-card bg-white rounded-xl p-6 card-shadow" id="option2" onclick="selectOption(2)">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl">üí∞</span>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">Keep EMI Unchanged</h3>
                        <p class="text-sm text-gray-600">Adjust tenure only</p>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">EMI</span>
                            <span class="font-semibold" id="option2EMI">‚Çπ26,507</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">New Tenure</span>
                            <span class="font-bold text-green-600" id="option2Tenure">98 months</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Interest</span>
                            <span class="font-semibold" id="option2Interest">‚Çπ7,71,574</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">DTI Ratio</span>
                            <span class="font-semibold" id="option2DTI">31.8%</span>
                        </div>
                        <div class="text-center mt-4">
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm" id="option2Savings">Finish 5 months early</span>
                        </div>
                    </div>
                </div>
                
                <!-- Option 3: Balanced -->
                <div class="option-card bg-white rounded-xl p-6 card-shadow" id="option3" onclick="selectOption(3)">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl">‚öñÔ∏è</span>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">Balanced Adjustment</h3>
                        <p class="text-sm text-gray-600">Optimize both EMI & tenure</p>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">New EMI</span>
                            <span class="font-bold text-purple-600" id="option3EMI">‚Çπ25,300</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">New Tenure</span>
                            <span class="font-bold text-purple-600" id="option3Tenure">100 months</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Interest</span>
                            <span class="font-semibold" id="option3Interest">‚Çπ7,67,366</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">DTI Ratio</span>
                            <span class="font-semibold" id="option3DTI">30.6%</span>
                        </div>
                        <div class="text-center mt-4">
                            <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm" id="option3Savings">Best of both worlds</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Comparison & Analytics -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Comparison Table -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Detailed Comparison</h3>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left text-gray-600">Aspect</th>
                                <th class="px-3 py-2 text-center text-gray-600">Current</th>
                                <th class="px-3 py-2 text-center text-gray-600">Best Option</th>
                                <th class="px-3 py-2 text-center text-gray-600">Savings</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-t">
                                <td class="px-3 py-2 font-medium">Interest Rate</td>
                                <td class="px-3 py-2 text-center" id="tableCurrentRate">10.75%</td>
                                <td class="px-3 py-2 text-center text-green-600" id="tableNewRate">8.75%</td>
                                <td class="px-3 py-2 text-center text-green-600" id="tableRateSaving">-2.00%</td>
                            </tr>
                            <tr class="border-t bg-gray-50">
                                <td class="px-3 py-2 font-medium">EMI Amount</td>
                                <td class="px-3 py-2 text-center" id="tableCurrentEMI">‚Çπ26,507</td>
                                <td class="px-3 py-2 text-center text-green-600" id="tableBestEMI">‚Çπ24,186</td>
                                <td class="px-3 py-2 text-center text-green-600" id="tableEMISaving">-‚Çπ2,321</td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-3 py-2 font-medium">Remaining Months</td>
                                <td class="px-3 py-2 text-center" id="tableCurrentMonths">103</td>
                                <td class="px-3 py-2 text-center text-green-600" id="tableBestMonths">98</td>
                                <td class="px-3 py-2 text-center text-green-600" id="tableMonthsSaving">-5</td>
                            </tr>
                            <tr class="border-t bg-gray-50">
                                <td class="px-3 py-2 font-medium">Total Interest</td>
                                <td class="px-3 py-2 text-center" id="tableCurrentTotalInterest">‚Çπ9,01,109</td>
                                <td class="px-3 py-2 text-center text-green-600" id="tableBestTotalInterest">‚Çπ7,63,158</td>
                                <td class="px-3 py-2 text-center text-green-600" id="tableTotalSaving">-‚Çπ1,37,951</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Payment Breakdown Chart -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Current Month Breakdown</h3>
                
                <div class="chart-container">
                    <div class="donut-chart" id="paymentChart" style="--interest-angle: 180deg;"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-lg font-bold text-gray-800">EMI Split</div>
                            <div class="text-sm text-gray-600">This Month</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-500" id="monthlyInterest">‚Çπ13,337</div>
                        <div class="text-sm text-gray-600">Interest (<span id="interestPercent">50.3%</span>)</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-500" id="monthlyPrincipal">‚Çπ13,170</div>
                        <div class="text-sm text-gray-600">Principal (<span id="principalPercent">49.7%</span>)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rate Sensitivity Analysis -->
        <div class="mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Rate Sensitivity Analysis</h3>
                
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="text-sm text-gray-600">@ 8.25%</div>
                        <div class="font-bold text-green-600" id="rate825">95 months</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="text-sm text-gray-600">@ 8.50%</div>
                        <div class="font-bold text-green-600" id="rate850">96 months</div>
                    </div>
                    <div class="text-center p-3 bg-blue-50 rounded-lg border-2 border-blue-200">
                        <div class="text-sm text-gray-600">@ 8.75% (New)</div>
                        <div class="font-bold text-blue-600" id="rateCurrent">98 months</div>
                    </div>
                    <div class="text-center p-3 bg-orange-50 rounded-lg">
                        <div class="text-sm text-gray-600">@ 9.00%</div>
                        <div class="font-bold text-orange-600" id="rate900">100 months</div>
                    </div>
                    <div class="text-center p-3 bg-red-50 rounded-lg">
                        <div class="text-sm text-gray-600">@ 9.25%</div>
                        <div class="font-bold text-red-600" id="rate925">102 months</div>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-yellow-50 rounded-lg">
                    <p class="text-sm text-yellow-800">
                        <strong>Floating Rate Impact:</strong> A 0.25% rate change typically affects your tenure by ¬±1-2 months 
                        when keeping EMI constant. Plan accordingly for rate volatility.
                    </p>
                </div>
            </div>
        </div>

        <!-- Amortization Schedules Section -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                    <span class="w-3 h-3 bg-indigo-500 rounded-full mr-3"></span>
                    Amortization Schedules
                </h2>
                <div class="flex space-x-3 no-print">
                    <button onclick="showSchedule('original')" 
                            id="showOriginalBtn"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Show Original Schedule
                    </button>
                    <button onclick="showSchedule('new')" 
                            id="showNewBtn"
                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        Show New Schedule
                    </button>
                    <button onclick="showSchedule('both')" 
                            id="showBothBtn"
                            class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                        Compare Both
                    </button>
                </div>
            </div>

            <!-- Original Schedule -->
            <div id="originalSchedule" class="bg-white rounded-xl p-6 card-shadow mb-6" style="display: none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Original Payment Schedule (Current Terms)</h3>
                    <div class="flex space-x-2 no-print">
                        <button onclick="exportScheduleCSV('original')" 
                                class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">
                            Export CSV
                        </button>
                        <button onclick="printSchedule('original')" 
                                class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition-colors">
                            Print
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 p-4 bg-blue-50 rounded-lg">
                    <div class="text-center">
                        <div class="text-lg font-bold text-blue-600" id="originalScheduleSummary1">‚Çπ26,507</div>
                        <div class="text-sm text-gray-600">Monthly EMI</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-blue-600" id="originalScheduleSummary2">103 months</div>
                        <div class="text-sm text-gray-600">Remaining Tenure</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-blue-600" id="originalScheduleSummary3">‚Çπ9,01,109</div>
                        <div class="text-sm text-gray-600">Total Interest</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-blue-600" id="originalScheduleSummary4">‚Çπ27,30,221</div>
                        <div class="text-sm text-gray-600">Total Payment</div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm" id="originalScheduleTable">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left">Payment #</th>
                                <th class="px-3 py-2 text-left">Date</th>
                                <th class="px-3 py-2 text-right">EMI</th>
                                <th class="px-3 py-2 text-right">Interest</th>
                                <th class="px-3 py-2 text-right">Principal</th>
                                <th class="px-3 py-2 text-right">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="originalScheduleBody">
                            <!-- Generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- New Schedule -->
            <div id="newSchedule" class="bg-white rounded-xl p-6 card-shadow mb-6" style="display: none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">New Payment Schedule (Revised Terms)</h3>
                    <div class="flex space-x-2 no-print">
                        <button onclick="exportScheduleCSV('new')" 
                                class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors">
                            Export CSV
                        </button>
                        <button onclick="printSchedule('new')" 
                                class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition-colors">
                            Print
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 p-4 bg-green-50 rounded-lg">
                    <div class="text-center">
                        <div class="text-lg font-bold text-green-600" id="newScheduleSummary1">‚Çπ26,507</div>
                        <div class="text-sm text-gray-600">Monthly EMI</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-green-600" id="newScheduleSummary2">98 months</div>
                        <div class="text-sm text-gray-600">Remaining Tenure</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-green-600" id="newScheduleSummary3">‚Çπ7,71,574</div>
                        <div class="text-sm text-gray-600">Total Interest</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-green-600" id="newScheduleSummary4">‚Çπ25,97,686</div>
                        <div class="text-sm text-gray-600">Total Payment</div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm" id="newScheduleTable">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left">Payment #</th>
                                <th class="px-3 py-2 text-left">Date</th>
                                <th class="px-3 py-2 text-right">EMI</th>
                                <th class="px-3 py-2 text-right">Interest</th>
                                <th class="px-3 py-2 text-right">Principal</th>
                                <th class="px-3 py-2 text-right">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="newScheduleBody">
                            <!-- Generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Comparison Schedule -->
            <div id="comparisonSchedule" class="bg-white rounded-xl p-6 card-shadow mb-6" style="display: none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Side-by-Side Comparison</h3>
                    <div class="flex space-x-2 no-print">
                        <button onclick="exportScheduleCSV('comparison')" 
                                class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600 transition-colors">
                            Export Comparison
                        </button>
                        <button onclick="printSchedule('comparison')" 
                                class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition-colors">
                            Print Comparison
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Original Summary -->
                    <div class="p-4 bg-red-50 rounded-lg">
                        <h4 class="font-semibold text-red-800 mb-2">Original Terms</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>EMI:</span>
                                <span class="font-semibold" id="compOriginalEMI">‚Çπ26,507</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tenure:</span>
                                <span class="font-semibold" id="compOriginalTenure">103 months</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Interest:</span>
                                <span class="font-semibold" id="compOriginalInterest">‚Çπ9,01,109</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Summary -->
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h4 class="font-semibold text-green-800 mb-2">Revised Terms</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>EMI:</span>
                                <span class="font-semibold" id="compNewEMI">‚Çπ26,507</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tenure:</span>
                                <span class="font-semibold" id="compNewTenure">98 months</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Interest:</span>
                                <span class="font-semibold" id="compNewInterest">‚Çπ7,71,574</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm" id="comparisonScheduleTable">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-2 py-2 text-left">Payment #</th>
                                <th class="px-2 py-2 text-center" colspan="3">Original Terms</th>
                                <th class="px-2 py-2 text-center" colspan="3">Revised Terms</th>
                                <th class="px-2 py-2 text-center">Savings</th>
                            </tr>
                            <tr class="bg-gray-50 border-t">
                                <th class="px-2 py-1 text-xs"></th>
                                <th class="px-2 py-1 text-xs">Interest</th>
                                <th class="px-2 py-1 text-xs">Principal</th>
                                <th class="px-2 py-1 text-xs">Balance</th>
                                <th class="px-2 py-1 text-xs">Interest</th>
                                <th class="px-2 py-1 text-xs">Principal</th>
                                <th class="px-2 py-1 text-xs">Balance</th>
                                <th class="px-2 py-1 text-xs">Interest</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonScheduleBody">
                            <!-- Generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow mb-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Decision Support Framework</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">üìä Financial Health</h4>
                    <div class="text-sm text-blue-700">
                        <p class="mb-1">Current DTI: <span id="healthDTI" class="font-bold">31.5%</span></p>
                        <p class="mb-1">Status: <span id="healthStatus" class="font-bold">Healthy</span></p>
                        <p>Recommendation: <span id="healthReco" class="font-bold">Consider Option 1 for lower EMI</span></p>
                    </div>
                </div>
                
                <div class="p-4 bg-green-50 rounded-lg">
                    <h4 class="font-semibold text-green-800 mb-2">üí° Smart Choice</h4>
                    <div class="text-sm text-green-700">
                        <p class="mb-1">Best Option: <span id="smartChoice" class="font-bold">Keep EMI Unchanged</span></p>
                        <p class="mb-1">Benefit: <span id="smartBenefit" class="font-bold">Finish 5 months early</span></p>
                        <p>Total Savings: <span id="smartSavings" class="font-bold">‚Çπ1,32,535</span></p>
                    </div>
                </div>
                
                <div class="p-4 bg-purple-50 rounded-lg">
                    <h4 class="font-semibold text-purple-800 mb-2">üéØ Recommendation</h4>
                    <div class="text-sm text-purple-700">
                        <p class="mb-1">Age Factor: <span id="ageFactor" class="font-bold">Consider early completion</span></p>
                        <p class="mb-1">Cash Flow: <span id="cashFlow" class="font-bold">Stable income supports current EMI</span></p>
                        <p>Action: <span id="recommendedAction" class="font-bold">Proceed with Option 2</span></p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-semibold text-gray-800 mb-2">üìã Next Steps</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="font-medium text-gray-700 mb-1">1. Review with Bank</p>
                        <p class="text-gray-600">Discuss your preferred option with your loan officer</p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-700 mb-1">2. Document Changes</p>
                        <p class="text-gray-600">Get written confirmation of new terms</p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-700 mb-1">3. Update Auto-Pay</p>
                        <p class="text-gray-600">Adjust standing instructions if EMI changes</p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-700 mb-1">4. Monitor Rates</p>
                        <p class="text-gray-600">Keep track of future floating rate changes</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- RBI Compliance Information -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl p-6 mb-8">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <span class="text-2xl mr-3">üèõÔ∏è</span>
                RBI Guidelines & Your Rights
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold mb-2">Your Rights as a Borrower:</h4>
                    <ul class="text-sm space-y-1 text-blue-100">
                        <li>‚Ä¢ Choice in how to adjust your loan terms</li>
                        <li>‚Ä¢ Clear communication about rate changes</li>
                        <li>‚Ä¢ Option to switch to fixed rate</li>
                        <li>‚Ä¢ No negative amortization</li>
                        <li>‚Ä¢ Quarterly statements with full details</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">Bank's Obligations:</h4>
                    <ul class="text-sm space-y-1 text-blue-100">
                        <li>‚Ä¢ Transparent disclosure of all charges</li>
                        <li>‚Ä¢ Advance notice of rate changes</li>
                        <li>‚Ä¢ Offer multiple adjustment options</li>
                        <li>‚Ä¢ Written consent for major changes</li>
                        <li>‚Ä¢ Clear explanation of implications</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-500 text-sm mb-4">
            <p class="mb-2">This calculator is for informational purposes only. Please consult with your financial advisor for personalized advice.</p>
            <p>Calculations based on RBI guidelines effective August 2023 | Last updated: <span id="lastUpdated"></span></p>
        </div>
    </div>

    <script>
        // Amortization schedule functions
        function generateSchedule(principal, rate, tenure, emi, startMonth = 1, startDate = new Date()) {
            const schedule = [];
            let balance = principal;
            const monthlyRate = rate / 1200;
            
            for (let month = 0; month < tenure && balance > 0.01; month++) {
                const interest = balance * monthlyRate;
                const principalPayment = Math.min(emi - interest, balance);
                balance -= principalPayment;
                
                const paymentDate = new Date(startDate);
                paymentDate.setMonth(paymentDate.getMonth() + month);
                
                schedule.push({
                    paymentNumber: startMonth + month,
                    date: paymentDate,
                    emi: emi,
                    interest: interest,
                    principal: principalPayment,
                    balance: Math.max(0, balance)
                });
                
                if (balance <= 0.01) break;
            }
            
            return schedule;
        }

        function showSchedule(type) {
            // Hide all schedules first
            document.getElementById('originalSchedule').style.display = 'none';
            document.getElementById('newSchedule').style.display = 'none';
            document.getElementById('comparisonSchedule').style.display = 'none';
            
            // Reset button styles
            ['showOriginalBtn', 'showNewBtn', 'showBothBtn'].forEach(id => {
                const btn = document.getElementById(id);
                btn.className = btn.className.replace(/bg-(blue|green|purple)-600/, 'bg-$1-500');
            });
            
            // Get current loan data
            const originalAmount = parseFloat(document.getElementById('originalAmount').value) || 2000000;
            const currentRate = parseFloat(document.getElementById('currentRate').value) || 10.75;
            const newRate = parseFloat(document.getElementById('newRate').value) || 8.75;
            const originalTenure = parseInt(document.getElementById('originalTenure').value) || 120;
            const emisPaid = parseInt(document.getElementById('emisPaid').value) || 17;
            
            const currentEMI = calculateEMI(originalAmount, currentRate, originalTenure);
            const outstanding = calculateOutstanding(originalAmount, currentRate, originalTenure, emisPaid);
            const remainingTenure = originalTenure - emisPaid;
            const newTenure = calculateTenure(outstanding, newRate, currentEMI);
            
            const startDate = new Date();
            startDate.setDate(6); // Assume rate change from 6th of current month
            
            if (type === 'original') {
                document.getElementById('originalSchedule').style.display = 'block';
                document.getElementById('showOriginalBtn').className = 
                    document.getElementById('showOriginalBtn').className.replace('bg-blue-500', 'bg-blue-600');
                generateOriginalSchedule(outstanding, currentRate, remainingTenure, currentEMI, emisPaid + 1, startDate);
            } else if (type === 'new') {
                document.getElementById('newSchedule').style.display = 'block';
                document.getElementById('showNewBtn').className = 
                    document.getElementById('showNewBtn').className.replace('bg-green-500', 'bg-green-600');
                generateNewSchedule(outstanding, newRate, newTenure, currentEMI, emisPaid + 1, startDate);
            } else if (type === 'both') {
                document.getElementById('comparisonSchedule').style.display = 'block';
                document.getElementById('showBothBtn').className = 
                    document.getElementById('showBothBtn').className.replace('bg-purple-500', 'bg-purple-600');
                generateComparisonSchedule(outstanding, currentRate, newRate, remainingTenure, newTenure, currentEMI, emisPaid + 1, startDate);
            }
        }

        function generateOriginalSchedule(principal, rate, tenure, emi, startMonth, startDate) {
            const schedule = generateSchedule(principal, rate, tenure, emi, startMonth, startDate);
            
            // Update summary
            const totalInterest = schedule.reduce((sum, payment) => sum + payment.interest, 0);
            const totalPayment = schedule.reduce((sum, payment) => sum + payment.emi, 0);
            
            document.getElementById('originalScheduleSummary1').textContent = formatCurrency(emi);
            document.getElementById('originalScheduleSummary2').textContent = tenure + ' months';
            document.getElementById('originalScheduleSummary3').textContent = formatCurrency(totalInterest);
            document.getElementById('originalScheduleSummary4').textContent = formatCurrency(totalPayment);
            
            // Generate table
            const tbody = document.getElementById('originalScheduleBody');
            tbody.innerHTML = '';
            
            schedule.forEach((payment, index) => {
                const row = tbody.insertRow();
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-3 py-2">${payment.paymentNumber}</td>
                    <td class="px-3 py-2">${payment.date.toLocaleDateString('en-IN')}</td>
                    <td class="px-3 py-2 text-right">${formatCurrency(payment.emi)}</td>
                    <td class="px-3 py-2 text-right text-red-600">${formatCurrency(payment.interest)}</td>
                    <td class="px-3 py-2 text-right text-green-600">${formatCurrency(payment.principal)}</td>
                    <td class="px-3 py-2 text-right font-semibold">${formatCurrency(payment.balance)}</td>
                `;
            });
        }

        function generateNewSchedule(principal, rate, tenure, emi, startMonth, startDate) {
            const schedule = generateSchedule(principal, rate, tenure, emi, startMonth, startDate);
            
            // Update summary
            const totalInterest = schedule.reduce((sum, payment) => sum + payment.interest, 0);
            const totalPayment = schedule.reduce((sum, payment) => sum + payment.emi, 0);
            
            document.getElementById('newScheduleSummary1').textContent = formatCurrency(emi);
            document.getElementById('newScheduleSummary2').textContent = tenure + ' months';
            document.getElementById('newScheduleSummary3').textContent = formatCurrency(totalInterest);
            document.getElementById('newScheduleSummary4').textContent = formatCurrency(totalPayment);
            
            // Generate table
            const tbody = document.getElementById('newScheduleBody');
            tbody.innerHTML = '';
            
            schedule.forEach((payment, index) => {
                const row = tbody.insertRow();
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-3 py-2">${payment.paymentNumber}</td>
                    <td class="px-3 py-2">${payment.date.toLocaleDateString('en-IN')}</td>
                    <td class="px-3 py-2 text-right">${formatCurrency(payment.emi)}</td>
                    <td class="px-3 py-2 text-right text-red-600">${formatCurrency(payment.interest)}</td>
                    <td class="px-3 py-2 text-right text-green-600">${formatCurrency(payment.principal)}</td>
                    <td class="px-3 py-2 text-right font-semibold">${formatCurrency(payment.balance)}</td>
                `;
            });
        }

        function generateComparisonSchedule(principal, oldRate, newRate, oldTenure, newTenure, emi, startMonth, startDate) {
            const oldSchedule = generateSchedule(principal, oldRate, oldTenure, emi, startMonth, startDate);
            const newSchedule = generateSchedule(principal, newRate, newTenure, emi, startMonth, startDate);
            
            // Update comparison summaries
            const oldTotalInterest = oldSchedule.reduce((sum, payment) => sum + payment.interest, 0);
            const newTotalInterest = newSchedule.reduce((sum, payment) => sum + payment.interest, 0);
            
            document.getElementById('compOriginalEMI').textContent = formatCurrency(emi);
            document.getElementById('compOriginalTenure').textContent = oldTenure + ' months';
            document.getElementById('compOriginalInterest').textContent = formatCurrency(oldTotalInterest);
            
            document.getElementById('compNewEMI').textContent = formatCurrency(emi);
            document.getElementById('compNewTenure').textContent = newTenure + ' months';
            document.getElementById('compNewInterest').textContent = formatCurrency(newTotalInterest);
            
            // Generate comparison table
            const tbody = document.getElementById('comparisonScheduleBody');
            tbody.innerHTML = '';
            
            const maxLength = Math.max(oldSchedule.length, newSchedule.length);
            
            for (let i = 0; i < maxLength; i++) {
                const oldPayment = i < oldSchedule.length ? oldSchedule[i] : null;
                const newPayment = i < newSchedule.length ? newSchedule[i] : null;
                
                const row = tbody.insertRow();
                row.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                const interestSaving = oldPayment && newPayment ? 
                    oldPayment.interest - newPayment.interest : 
                    (oldPayment ? oldPayment.interest : 0);
                
                row.innerHTML = `
                    <td class="px-2 py-2 text-sm">${startMonth + i}</td>
                    <td class="px-2 py-2 text-right text-xs text-red-600">
                        ${oldPayment ? formatCurrency(oldPayment.interest) : '-'}
                    </td>
                    <td class="px-2 py-2 text-right text-xs text-green-600">
                        ${oldPayment ? formatCurrency(oldPayment.principal) : '-'}
                    </td>
                    <td class="px-2 py-2 text-right text-xs">
                        ${oldPayment ? formatCurrency(oldPayment.balance) : '-'}
                    </td>
                    <td class="px-2 py-2 text-right text-xs text-red-600">
                        ${newPayment ? formatCurrency(newPayment.interest) : '-'}
                    </td>
                    <td class="px-2 py-2 text-right text-xs text-green-600">
                        ${newPayment ? formatCurrency(newPayment.principal) : '-'}
                    </td>
                    <td class="px-2 py-2 text-right text-xs">
                        ${newPayment ? formatCurrency(newPayment.balance) : '-'}
                    </td>
                    <td class="px-2 py-2 text-right text-xs ${interestSaving > 0 ? 'text-green-600' : 'text-gray-400'}">
                        ${interestSaving > 0 ? formatCurrency(interestSaving) : '-'}
                    </td>
                `;
            }
        }

        // Export and print functions
        function exportScheduleCSV(type) {
            let csvContent = "data:text/csv;charset=utf-8,";
            let filename = "";
            
            if (type === 'original') {
                csvContent += "Payment #,Date,EMI,Interest,Principal,Balance\n";
                filename = "original_loan_schedule.csv";
                
                const table = document.getElementById('originalScheduleTable');
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    const rowData = Array.from(cols).map(col => 
                        col.textContent.replace(/[‚Çπ,]/g, '').trim()
                    ).join(',');
                    csvContent += rowData + "\n";
                });
                
            } else if (type === 'new') {
                csvContent += "Payment #,Date,EMI,Interest,Principal,Balance\n";
                filename = "new_loan_schedule.csv";
                
                const table = document.getElementById('newScheduleTable');
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    const rowData = Array.from(cols).map(col => 
                        col.textContent.replace(/[‚Çπ,]/g, '').trim()
                    ).join(',');
                    csvContent += rowData + "\n";
                });
                
            } else if (type === 'comparison') {
                csvContent += "Payment #,Old Interest,Old Principal,Old Balance,New Interest,New Principal,New Balance,Interest Saving\n";
                filename = "loan_schedule_comparison.csv";
                
                const table = document.getElementById('comparisonScheduleTable');
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    const rowData = Array.from(cols).map(col => 
                        col.textContent.replace(/[‚Çπ,]/g, '').trim()
                    ).join(',');
                    csvContent += rowData + "\n";
                });
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printSchedule(type) {
            const printWindow = window.open('', '', 'height=600,width=800');
            let content = '';
            
            if (type === 'original') {
                content = document.getElementById('originalSchedule').innerHTML;
            } else if (type === 'new') {
                content = document.getElementById('newSchedule').innerHTML;
            } else if (type === 'comparison') {
                content = document.getElementById('comparisonSchedule').innerHTML;
            }
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Loan Amortization Schedule</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                        th { background-color: #f5f5f5; }
                        .no-print { display: none; }
                        h3 { color: #333; margin-bottom: 10px; }
                        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
                        .summary > div { text-align: center; padding: 10px; background: #f9f9f9; border-radius: 5px; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }
        
        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(Math.round(num));
        }

        // Mathematical calculation functions
        function calculateOutstanding(principal, rate, tenure, paid) {
            const monthlyRate = rate / 1200;
            const factor1 = Math.pow(1 + monthlyRate, tenure);
            const factor2 = Math.pow(1 + monthlyRate, paid);
            return principal * (factor1 - factor2) / (factor1 - 1);
        }

        function calculateTenure(principal, rate, emi) {
            const monthlyRate = rate / 1200;
            const ratio = (principal * monthlyRate) / emi;
            if (ratio >= 1) return 999; // Invalid scenario
            return Math.ceil(-Math.log(1 - ratio) / Math.log(1 + monthlyRate));
        }

        function calculateEMI(principal, rate, tenure) {
            const monthlyRate = rate / 1200;
            const factor = Math.pow(1 + monthlyRate, tenure);
            return principal * monthlyRate * factor / (factor - 1);
        }

        function calculateTotalInterest(emi, tenure, principal) {
            return (emi * tenure) - principal;
        }

        function calculateDTI(emi, otherEMIs, monthlyIncome) {
            return ((emi + otherEMIs) / monthlyIncome) * 100;
        }

        // Main calculation function
        function calculateAll() {
            try {
                // Get input values
                const originalAmount = parseFloat(document.getElementById('originalAmount').value) || 2000000;
                const currentRate = parseFloat(document.getElementById('currentRate').value) || 10.75;
                const newRate = parseFloat(document.getElementById('newRate').value) || 8.75;
                const originalTenure = parseInt(document.getElementById('originalTenure').value) || 120;
                const emisPaid = parseInt(document.getElementById('emisPaid').value) || 17;
                const grossIncome = parseFloat(document.getElementById('grossIncome').value) || 1200000;
                const otherEMIs = parseFloat(document.getElementById('otherEMIs').value) || 5000;

                // Calculate EMI based on original loan terms
                const currentEMI = calculateEMI(originalAmount, currentRate, originalTenure);
                
                // Update the calculated EMI display
                document.getElementById('calculatedEMIDisplay').textContent = formatCurrency(currentEMI);

                // Calculate derived values
                const outstanding = calculateOutstanding(originalAmount, currentRate, originalTenure, emisPaid);
                const amountPaid = emisPaid * currentEMI;
                const principalPaid = originalAmount - outstanding;
                const interestPaid = amountPaid - principalPaid;
                const progress = (emisPaid / originalTenure) * 100;
                const monthlyIncome = grossIncome / 12;
                const remainingTenure = originalTenure - emisPaid;

                // Update loan overview
                document.getElementById('originalAmountDisplay').textContent = formatCurrency(originalAmount);
                document.getElementById('amountPaidDisplay').textContent = formatCurrency(amountPaid);
                document.getElementById('outstandingDisplay').textContent = formatCurrency(outstanding);
                document.getElementById('progressDisplay').textContent = progress.toFixed(1) + '%';
                document.getElementById('progressText').textContent = progress.toFixed(1) + '% Complete';
                document.getElementById('mainProgressBar').style.width = progress + '%';
                document.getElementById('emisPaidText').textContent = emisPaid + ' EMIs Paid';

                // Update income analysis
                document.getElementById('monthlyIncomeDisplay').textContent = formatCurrency(monthlyIncome);
                document.getElementById('totalEMIsDisplay').textContent = formatCurrency(currentEMI + otherEMIs);
                document.getElementById('currentDTIDisplay').textContent = calculateDTI(currentEMI, otherEMIs, monthlyIncome).toFixed(1) + '%';

                // Calculate three options
                
                // Option 1: Keep tenure unchanged, adjust EMI
                const option1Tenure = remainingTenure;
                const option1EMI = calculateEMI(outstanding, newRate, option1Tenure);
                const option1Interest = calculateTotalInterest(option1EMI, option1Tenure, outstanding);
                const option1DTI = calculateDTI(option1EMI, otherEMIs, monthlyIncome);

                // Option 2: Keep EMI unchanged, adjust tenure
                const option2EMI = currentEMI;
                const option2Tenure = calculateTenure(outstanding, newRate, option2EMI);
                const option2Interest = calculateTotalInterest(option2EMI, option2Tenure, outstanding);
                const option2DTI = calculateDTI(option2EMI, otherEMIs, monthlyIncome);

                // Option 3: Balanced approach (reduce both EMI and tenure moderately)
                const targetTenureReduction = Math.floor((remainingTenure - option2Tenure) * 0.6);
                const option3Tenure = remainingTenure - targetTenureReduction;
                const option3EMI = calculateEMI(outstanding, newRate, option3Tenure);
                const option3Interest = calculateTotalInterest(option3EMI, option3Tenure, outstanding);
                const option3DTI = calculateDTI(option3EMI, otherEMIs, monthlyIncome);

                // Update Option 1
                document.getElementById('option1EMI').textContent = formatCurrency(option1EMI);
                document.getElementById('option1Tenure').textContent = option1Tenure + ' months';
                document.getElementById('option1Interest').textContent = formatCurrency(option1Interest);
                document.getElementById('option1DTI').textContent = option1DTI.toFixed(1) + '%';
                document.getElementById('option1Savings').textContent = 'Save ' + formatCurrency(currentEMI - option1EMI) + '/month';

                // Update Option 2
                document.getElementById('option2EMI').textContent = formatCurrency(option2EMI);
                document.getElementById('option2Tenure').textContent = option2Tenure + ' months';
                document.getElementById('option2Interest').textContent = formatCurrency(option2Interest);
                document.getElementById('option2DTI').textContent = option2DTI.toFixed(1) + '%';
                document.getElementById('option2Savings').textContent = 'Finish ' + (remainingTenure - option2Tenure) + ' months early';

                // Update Option 3
                document.getElementById('option3EMI').textContent = formatCurrency(option3EMI);
                document.getElementById('option3Tenure').textContent = option3Tenure + ' months';
                document.getElementById('option3Interest').textContent = formatCurrency(option3Interest);
                document.getElementById('option3DTI').textContent = option3DTI.toFixed(1) + '%';
                document.getElementById('option3Savings').textContent = 'Balanced benefits';

                // Update comparison table
                const currentTotalInterest = calculateTotalInterest(currentEMI, remainingTenure, outstanding);
                document.getElementById('tableCurrentRate').textContent = currentRate + '%';
                document.getElementById('tableNewRate').textContent = newRate + '%';
                document.getElementById('tableRateSaving').textContent = '-' + (currentRate - newRate).toFixed(2) + '%';
                document.getElementById('tableCurrentEMI').textContent = formatCurrency(currentEMI);
                document.getElementById('tableBestEMI').textContent = formatCurrency(option1EMI);
                document.getElementById('tableEMISaving').textContent = '-' + formatCurrency(currentEMI - option1EMI);
                document.getElementById('tableCurrentMonths').textContent = remainingTenure;
                document.getElementById('tableBestMonths').textContent = option2Tenure;
                document.getElementById('tableMonthsSaving').textContent = '-' + (remainingTenure - option2Tenure);
                document.getElementById('tableCurrentTotalInterest').textContent = formatCurrency(currentTotalInterest);
                document.getElementById('tableBestTotalInterest').textContent = formatCurrency(option1Interest);
                document.getElementById('tableTotalSaving').textContent = '-' + formatCurrency(currentTotalInterest - option1Interest);

                // Update current month breakdown with new rate
                const monthlyInterest = Math.round(outstanding * newRate / 1200);
                const monthlyPrincipal = currentEMI - monthlyInterest;
                const interestPercent = (monthlyInterest / currentEMI * 100);
                const principalPercent = (monthlyPrincipal / currentEMI * 100);

                document.getElementById('monthlyInterest').textContent = formatCurrency(monthlyInterest);
                document.getElementById('monthlyPrincipal').textContent = formatCurrency(monthlyPrincipal);
                document.getElementById('interestPercent').textContent = interestPercent.toFixed(1) + '%';
                document.getElementById('principalPercent').textContent = principalPercent.toFixed(1) + '%';

                // Update donut chart
                const chartElement = document.getElementById('paymentChart');
                chartElement.style.setProperty('--interest-angle', (interestPercent * 3.6) + 'deg');

                // Update rate sensitivity analysis
                const rates = [8.25, 8.50, newRate, 9.00, 9.25];
                const rateIds = ['rate825', 'rate850', 'rateCurrent', 'rate900', 'rate925'];
                
                rates.forEach((rate, index) => {
                    const tenure = calculateTenure(outstanding, rate, currentEMI);
                    if (rateIds[index]) {
                        document.getElementById(rateIds[index]).textContent = tenure + ' months';
                    }
                });

                // Update decision support
                const currentDTI = calculateDTI(currentEMI, otherEMIs, monthlyIncome);
                document.getElementById('healthDTI').textContent = currentDTI.toFixed(1) + '%';
                
                let healthStatus, healthReco, smartChoice, smartBenefit, smartSavings;
                
                if (currentDTI < 30) {
                    healthStatus = 'Excellent';
                    healthReco = 'You can handle higher EMIs safely';
                } else if (currentDTI < 40) {
                    healthStatus = 'Healthy';
                    healthReco = 'Current EMI levels are manageable';
                } else {
                    healthStatus = 'Stretched';
                    healthReco = 'Consider reducing EMI burden';
                }

                // Determine smart choice based on best total interest savings
                const options = [
                    { name: 'Keep Tenure Unchanged', interest: option1Interest, savings: currentTotalInterest - option1Interest },
                    { name: 'Keep EMI Unchanged', interest: option2Interest, savings: currentTotalInterest - option2Interest },
                    { name: 'Balanced Adjustment', interest: option3Interest, savings: currentTotalInterest - option3Interest }
                ];

                const bestOption = options.reduce((best, current) => 
                    current.savings > best.savings ? current : best);

                smartChoice = bestOption.name;
                smartSavings = formatCurrency(bestOption.savings);
                
                if (bestOption.name === 'Keep EMI Unchanged') {
                    smartBenefit = 'Finish ' + (remainingTenure - option2Tenure) + ' months early';
                } else if (bestOption.name === 'Keep Tenure Unchanged') {
                    smartBenefit = 'Save ' + formatCurrency(currentEMI - option1EMI) + '/month';
                } else {
                    smartBenefit = 'Optimal balance of EMI and tenure';
                }

                document.getElementById('healthStatus').textContent = healthStatus;
                document.getElementById('healthReco').textContent = healthReco;
                document.getElementById('smartChoice').textContent = smartChoice;
                document.getElementById('smartBenefit').textContent = smartBenefit;
                document.getElementById('smartSavings').textContent = smartSavings;

                // Age and cash flow recommendations
                document.getElementById('ageFactor').textContent = 'Consider early completion';
                document.getElementById('cashFlow').textContent = currentDTI < 35 ? 'Stable income supports current EMI' : 'Monitor cash flow carefully';
                document.getElementById('recommendedAction').textContent = healthStatus === 'Stretched' ? 'Proceed with Option 1' : 'Proceed with Option 2';

            } catch (error) {
                console.error('Calculation error:', error);
                alert('Please check your input values. Some calculations may be invalid.');
            }
        }

        // Option selection
        function selectOption(optionNumber) {
            // Remove previous selection
            for (let i = 1; i <= 3; i++) {
                document.getElementById('option' + i).classList.remove('selected');
            }
            
            // Add selection to clicked option
            document.getElementById('option' + optionNumber).classList.add('selected');
            currentSelectedOption = optionNumber;
            
            // Add visual feedback
            const selectedCard = document.getElementById('option' + optionNumber);
            selectedCard.classList.add('pulse-animation');
            setTimeout(() => {
                selectedCard.classList.remove('pulse-animation');
            }, 1000);
        }

        // Quick action functions
        function resetToDefaults() {
            document.getElementById('originalAmount').value = 2000000;
            document.getElementById('currentRate').value = 10.75;
            document.getElementById('newRate').value = 8.75;
            document.getElementById('originalTenure').value = 120;
            document.getElementById('emisPaid').value = 17;
            document.getElementById('grossIncome').value = 1200000;
            document.getElementById('otherEMIs').value = 5000;
            calculateAll();
        }

        function testScenario(type) {
            const currentNewRate = parseFloat(document.getElementById('newRate').value);
            
            if (type === 'higher') {
                document.getElementById('newRate').value = (currentNewRate + 1).toFixed(2);
            } else if (type === 'lower') {
                document.getElementById('newRate').value = Math.max(1, currentNewRate - 0.5).toFixed(2);
            }
            
            calculateAll();
            
            // Show alert with scenario info
            const newRate = document.getElementById('newRate').value;
            const message = type === 'higher' ? 
                `Scenario: Interest rate increased to ${newRate}%. Check the impact on your options.` :
                `Scenario: Interest rate reduced to ${newRate}%. See the additional benefits!`;
            
            setTimeout(() => alert(message), 100);
        }

        // Initialize application
        function initializeApp() {
            loadTheme(); // Load saved theme first
            calculateAll();
            selectOption(2); // Default to Option 2
            
            // Set last updated date
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('en-IN');
            
            // Add slide-in animation to cards
            const cards = document.querySelectorAll('.card-shadow');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('slide-in');
                }, index * 100);
            });
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (themeToggle.checked) {
                body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeToggle.checked = true;
            } else {
                document.body.removeAttribute('data-theme');
                themeToggle.checked = false;
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Add input event listeners for real-time updates
        ['originalAmount', 'currentRate', 'newRate', 'originalTenure', 'emisPaid', 'grossIncome', 'otherEMIs'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', calculateAll);
                element.addEventListener('change', calculateAll);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        resetToDefaults();
                        break;
                    case 'p':
                        e.preventDefault();
                        window.print();
                        break;
                    case '1':
                        e.preventDefault();
                        selectOption(1);
                        break;
                    case '2':
                        e.preventDefault();
                        selectOption(2);
                        break;
                    case '3':
                        e.preventDefault();
                        selectOption(3);
                        break;
                }
            }
        });

        // Print styles and functionality
        window.addEventListener('beforeprint', function() {
            document.body.classList.add('printing');
        });

        window.addEventListener('afterprint', function() {
            document.body.classList.remove('printing');
        });
    </script>
</body>
</html>
